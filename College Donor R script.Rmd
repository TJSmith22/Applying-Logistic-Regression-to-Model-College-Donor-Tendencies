---
title: "The Classifacation of A Binary Target Variable Using a Binomial Generalized Linear Model"
author: "TJ Smith"
date: "3/4/2022"
output:
  word_document: default
  html_document: default
---

Section 1 - Introduction

College is a staple in the world where young people pursue their passions and become well rounded adults. Older generations often donate to colleges so that the younger generations have sufficient opportunities to pursue their dreams. Similar to how students pick their colleges, there are a lot of factors that donors take into account when choosing a college to donate to. With so many different things to take into account, it can be difficult for the average donor to weigh their options. 

The data set at hand provides numerous variables that relate to colleges. An analysis of these variables can give a great indication to which variables are important in predicting the target variable. As prescribed in the problem, a binomial model will be used to analyze the data. 

The plan for the remainder of the report is as follows. Section 2 will discuss the nature of the data and provide some summary findings about the importance of it. The details of how we selected our model and the interpretation of that model will be found in section 3. The selected model will be applied in section 4 to exhibit how well it compares to the data itself. The report ends with section 5 which contains concluding remarks. 

```{r,include=FALSE}
library(tidyverse)
library(GLMsData)
library(MASS)
library(gridExtra)
library(statmod)
```

```{r,include=FALSE}
co <- read.csv("college.csv")
```

Section 2 - Data Characteristics

The data at hand is cross-sectional and observational, as the collection time of the data is undisclosed. It contains information from 500 different unnamed universities across the United States. We are given 17 factors (independent variables) that may sway ones decision when choosing a college to donate to. These different variables span a wide variety of topics such as financial(tuition,personal cost), academic (applicants accepted, percent of faculty with phd's), and other miscellaneous things such as graduation rate, student-faculty ratio, and percentage of alumni who donate. From these factors, the colleges are given a binary value of 0 or 1. It is our job to discover which variables play a significant role in determining whether the college is valued as a 0 or 1.

The graph below provides an example between the variable Outstate and the target outcome. It is quite clear that if there is a higher out of state tuition cost, the target variable is highly likely to be 1. From this, one could conclude that out of state tuition cost is a significant variable in predicting the target outcome. 

```{r,co-exploratory-plot-1}
pdc <- ggplot(data = co,
            mapping = aes(x = Outstate,
                          y = Target))
pdc <- pdc + geom_jitter(height = 0.02, pch = 1)
pdc <- pdc + geom_smooth(se=FALSE)
pdc <- pdc + labs(x = "Out of State Tuiton Cost",
              y = "Target Variable")
pdc
```

The target variable in the data set is categorized as a 0 or 1. As seen below, the mean of the target variable is 0.728, indicating that the classification of the target variable is more commonly a 1 as opposed to 0.

```{r}
summary(co$Target)
```

Section 3 - Model Selection/Interpretation

The previous section provided provided preliminary plots and summary statistics for the data we have at hand. This section will discuss the process of narrowing down the data to fit a binomial generalized linear model. Following the final model and its interpretation, the section will exhibit some graphics that drove the selection of this specific model. 

As we were tasked for creating a binomial model, there was no need for analysis to find the correct family of functions to use. 


```{r,include=FALSE}
fullmodel <- glm(Target ~ Apps+Accept+Enroll+Top10perc+Top25perc+F.Undergrad+P.Undergrad+Outstate+Room.Board+Books+Personal+PhD+Terminal+S.F.Ratio+perc.alumni+Expend+Grad.Rate,data=co,family=binomial)
summary(fullmodel)
```

```{r,include=FALSE}
anova(fullmodel,test="Chisq",data=co)
```

```{r,include=FALSE}
adjmodel1 <- glm(Target ~ Apps+Accept+Enroll+Top10perc+Top25perc+F.Undergrad+Outstate+PhD+perc.alumni,data=co,family=binomial)
summary(adjmodel1)
```


```{r,include=FALSE}
adjmodel2 <- glm(Target ~ Apps+Accept+Enroll+Top10perc+Top25perc+F.Undergrad+P.Undergrad+Room.Board+Books+Personal+Terminal+S.F.Ratio+Expend+Grad.Rate,data=co,family=binomial)
summary(adjmodel2)
```


```{r,include=FALSE}
adjmodel3 <- glm(Target ~ Outstate+PhD+perc.alumni+Apps+Enroll+F.Undergrad+Room.Board+Terminal+Expend+Grad.Rate,data=co,family=binomial)
summary(adjmodel3)
```

```{r,include=FALSE}
adjmodel4 <- glm(Target ~ Outstate+PhD+perc.alumni+Apps+F.Undergrad+Expend,data=co,family=binomial)
summary(adjmodel4)
```

The final model was fit using a combination of log-likelihood tests and Wald tests, which weeded out variables that proved insignificant in predicting our target variable. It was determined that the significant coefficients were Outstate, PhD, perc.alumni, Apps, and Expend which are described below. 

Outstate -> Out-of-state tuition
PhD -> Percent of faculty with PhD degrees
perc.alumni -> Percent of alumni who donate
Apps -> Number of applications received
Expend -> Instructional expenditure per student

A summary of the final model is shown below:

```{r}
adjmodel5 <- glm(Target ~ Outstate+PhD+perc.alumni+Apps+Expend,data=co,family=binomial)
summary(adjmodel5)
```

The equation for the final model:
$$
logit(mu) = -1.297 + 0.00072*Outstate + 0.0864*perc.alumni + 0.00027*Expend - 0.0835*phd - 0.00053*Apps
$$
Unlike a normal linear regression, the interpretation of the binomial generalized linear model can be quite difficult to understand. A variable can be interpreted as follows:

If out of state tuition is increased by $2,000 then there is a 1.448 (2000*0.0007242341) unit change in the log odds. Again it is difficult to interpret what a 1.448 increase in the log odds is, so we can convert this into an odds ratio, by exponentiating the coefficient. exp(1.448) = 4.25. An odds ratio of 4.25 tells us that we are 4.25 times more likely to predict target = 1 than target = 0.

To put everything together, in context, if out of state tuition is increased by $2,000, holding all other variables constant, we are 4.25 times more likely to predict the correct target variable. 


```{r,include=FALSE}
co$adjmodel5.mu <- predict(adjmodel5,type="response")
co$adjmodel5.eta <- predict(adjmodel5,type="link")
co$adjmodel5.Prediction <- ifelse(co$adjmodel5.mu>0.5,1,0)
```

```{r,include=FALSE}
co$adjmodel5.rQ1 <- qresid(adjmodel5)
co$adjmodel5.rQ2 <- qresid(adjmodel5)
```

An out-of-model vs quantile residual plot was used to ensure the model was not excluding any significant variables. If the plot exhibits a pattern that is drastically different than a line at y=0, then the variable may add value to the model. The most extreme case of deviation in the data of the room and board variable is show below. However there was not sufficient evidence that we needed it in the model, meaning there are no variables in the data set that would add any additional predicting value. 
```{r}
pom <- ggplot(data = co,
            mapping = aes(x = Room.Board,
                          y = adjmodel5.rQ1))
pom <- pom + geom_point() + geom_smooth(se = TRUE)
pom <- pom + labs(x = "Cost of Room and Board",
              y = "Quantile Residuals",
              title = "Model")

qom <- ggplot(data = co,
            mapping = aes(x = Room.Board,
                          y =adjmodel5.rQ2))
qom <- qom + geom_point() + geom_smooth(se = TRUE)
qom <- qom + labs(x = "Cost of Room and Board",
              y = "Quantile Residuals",
              title = "Model")
grid.arrange(pom, qom, nrow = 1)
```

```{r,co-fm2-working-response,include=FALSE}
co$adjmodel5.wr <- co$adjmodel5.eta + resid(adjmodel5,type="working")
```

Although it was specified to use a binomial generalized linear model, it important to ensure that the data at hand fits a binomial model. The sample quantile vs theoretical quantile plot is used to do this. If the sample quantiles fit a linear pattern, then the model chosen is correct. The graph below exhibits that the data fits the linear model, so the binomial family is the correct choice. 
```{r}
pt <- ggplot(data = co,
            mapping = aes(sample = adjmodel5.rQ1))
pt <- pt + geom_qq(pch = 1) + geom_qq_line(color = "blue")
pt <- pt + labs(x = "Theoretical Quantiles",
              y = "Sample Quantiles")

qt <- ggplot(data = co,
            mapping = aes(sample = adjmodel5.rQ2))
qt <- qt + geom_qq(pch = 1) + geom_qq_line(color = "blue")
qt <- qt + labs(x = "Theoretical Quantiles",
              y = "Sample Quantiles")
grid.arrange(pt, qt, nrow = 1)
```

These final two plots ensure that the link function is accurate and that the overall model is a good predictor. The linear predicting graph exhibits a clear straight line indicating that the link function of the model is a great fit. The fitted values vs quantile residuals plot demonstrates a line across x=0, indicating that the overall binomial generalized linear model is a great fit. 

```{r}
p <- ggplot(data = co,
            mapping = aes(x = adjmodel5.eta,
                          y = adjmodel5.wr))
p <- p + geom_point() + geom_smooth(se = TRUE)+ylim(-20,20)
p <- p + labs(x = "Linear Predictor",
              y = "Working Residuals",
              title = "Model")
p
```

```{r}
p <- ggplot(data = co,
            mapping = aes(x = adjmodel5.mu,
                          y = adjmodel5.rQ1))
p <- p + geom_point() + geom_smooth(se = TRUE)
p <- p + labs(x = "Fitted Values",
              y = "Quantile Residuals",
              title = "Model")

q <- ggplot(data = co,
            mapping = aes(x = adjmodel5.mu,
                          y = adjmodel5.rQ2))
q <- q + geom_point() + geom_smooth(se = TRUE)
q <- q + labs(x = "Fitted Values",
              y = "Quantile Residuals",
              title = "Model")
grid.arrange(p,q, nrow = 1)
```

Now that the model has been evaluated and determined that it is a good fit for the data, we need to determine how good the model actually is. One way to do this is by analyzing the models accuracy, sensitivity, and specificity using a confusion matrix, which is shown below.  

```{r}
(confmat<- xtabs( ~ Target + adjmodel5.Prediction,
       data = co))
```
  
The accuracy of our procedure is calculated by dividing the number of correct predictions by the total number of predictions. The model is calculated to be 93% accurate at predicting the correct target variable.
$$
  \frac{119+346}{119 + 18 + 17 + 346} = \frac{465}{500} = 0.93
$$
The sensitivity of the procedure determines how often the model correctly predicts when the target variable is 1. The model used is calculated to have a sensitivity of 95.05%, meaning when the target variable is 1, the model predicts a 1 95.05% of the time.
$$
  \frac{346}{18 + 346} = \frac{346}{364} = 0.9505
$$

The specificity of the procedure determines how often the model correctly predicts when the target variable is 0. The model is calculated to have a specificity of 87.5%, meaning that when the target variable is 0, the model predicts a 0 87.5% of the time.  
$$
  \frac{119}{119 + 17} = \frac{119}{136} = 0.875
$$


Section 4 - Score Function

The following function can be used to apply the binomial model created above, to a new data set containing the same variables. The function requires the user to pass in the data set, and the function will return the same data set, along with the predicted target value (0 or 1) based on the created binomial model. 

```{r,co-score-function}
score <- function(dta) {
  Outstate <- co$Outstate
  phd <- co$PhD
  perc.alumni <- co$perc.alumni
  Apps <- co$Apps
  Expend <- co$Expend
  eta <- -1.2978349723 + 0.0007242341*Outstate + 0.0864645073*perc.alumni + 0.0002704450*Expend - 0.0835232929*phd - 0.0005358043*Apps
  mu <- 1/(1+exp(-eta))
  co$Prediction <- ifelse(mu>0.5 ,1,0)
  return(co)
}
```

```{r}
tmps <- score(co)
```

Section 5 - Conclusion

Although many variables can effect the decision to donate to a college, it is possible to establish a model that determines the target variable well. The Binomial model that was fit to the data uses Outstate, PhD, perc.alumni, Apps, and Expend to predict the outcome variable. 

The analysis of this data is based on the classification by educational donors of the target variable. This model may not translate to other educational donors, as the variables used in this model may not be as significant in determining the target variable for others. Nonetheless, the techniques used in this report are applicable to other college data sets assembled by the same educational donors. 